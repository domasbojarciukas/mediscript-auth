<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mediscript Auth Bridge</title>
</head>
<body>
  <script>
    (function () {
      // ----------------------------
      // Read config from URL params
      // Example:
      //   auth.html?app=https://mediscript.streamlit.app&supabase=https://xxxx.supabase.co&state=...
      // ----------------------------
      const urlNow = new URL(window.location.href);

      const APP_URL = (urlNow.searchParams.get("app") || "").trim();
      const SUPABASE_URL = (urlNow.searchParams.get("supabase") || "").trim().replace(/\/$/, "");

      // Optional passthrough params
      const next = urlNow.searchParams.get("next") || "";
      const state_in = urlNow.searchParams.get("state") || ""; // state generated by Streamlit

      // Basic validation (avoid redirecting to empty/invalid)
      const isHttps = (s) => /^https:\/\/.+/i.test(s);
      if (!isHttps(APP_URL) || !isHttps(SUPABASE_URL)) {
        // If misconfigured, fail safely (do nothing / show nothing)
        return;
      }

      // ----------------------------
      // 1) If tokens returned in hash (#access_token=...), forward to Streamlit as query params
      // ----------------------------
      const hash = window.location.hash || "";
      const hashParams = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : "");

      const access_token = hashParams.get("access_token");
      const refresh_token = hashParams.get("refresh_token");
      const expires_in = hashParams.get("expires_in");
      const token_type = hashParams.get("token_type");

      // ✅ state may come back in hash; if not, use the state we received on entry
      const state_back = hashParams.get("state") || state_in;

      const error = hashParams.get("error") || urlNow.searchParams.get("error");
      const error_description =
        hashParams.get("error_description") || urlNow.searchParams.get("error_description");

      if (error || error_description) {
        const out = new URL(APP_URL);
        if (next) out.searchParams.set("next", next);
        if (state_back) out.searchParams.set("state", state_back);
        if (error) out.searchParams.set("error", error);
        if (error_description) out.searchParams.set("error_description", error_description);
        window.location.replace(out.toString());
        return;
      }

      if (access_token && refresh_token) {
        const out = new URL(APP_URL);
        if (next) out.searchParams.set("next", next);

        // ✅ forward state so Streamlit can verify CSRF
        if (state_back) out.searchParams.set("state", state_back);

        out.searchParams.set("access_token", access_token);
        out.searchParams.set("refresh_token", refresh_token);
        if (expires_in) out.searchParams.set("expires_in", expires_in);
        if (token_type) out.searchParams.set("token_type", token_type);

        window.location.replace(out.toString());
        return;
      }

      // ----------------------------
      // 2) Otherwise start OAuth (this page acts as both entry + return)
      // ----------------------------
      // Guard to avoid infinite loops if something fails before returning tokens
      const guardKey = "ms_oauth_attempted";
      const attempted = sessionStorage.getItem(guardKey);

      if (attempted === "1") {
        const out = new URL(APP_URL);
        if (next) out.searchParams.set("next", next);
        if (state_in) out.searchParams.set("state", state_in);
        out.searchParams.set("error", "oauth_failed");
        out.searchParams.set(
          "error_description",
          "OAuth did not return tokens. Check Supabase Redirect URLs and Google provider config."
        );
        window.location.replace(out.toString());
        return;
      }
      sessionStorage.setItem(guardKey, "1");

      // Build authorize URL
      const authorize = new URL(SUPABASE_URL + "/auth/v1/authorize");
      authorize.searchParams.set("provider", "google");

      // redirect_to must point back to THIS PAGE (no hash)
      // Keep the original query params so we still have app/supabase/state/next on return
      authorize.searchParams.set("redirect_to", window.location.href.split("#")[0]);

      // Implicit flow so we get tokens in hash
      authorize.searchParams.set("response_type", "token");

      // Pass state through to Supabase (and typically back to us)
      if (state_in) authorize.searchParams.set("state", state_in);

      // Optional: ask for refresh token from Google (consent screen)
      authorize.searchParams.set("access_type", "offline");
      authorize.searchParams.set("prompt", "consent");

      window.location.replace(authorize.toString());
    })();
  </script>
</body>
</html>

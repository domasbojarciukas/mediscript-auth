<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Mediscript Auth</title>
  </head>
  <body>
    <script type="module">
  const SUPABASE_URL = "https://YOURPROJECT.supabase.co";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";
  const STREAMLIT_APP_URL = "https://mediscript.streamlit.app";
  const THIS_PAGE_URL = window.location.origin + window.location.pathname;

  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
    },
  });

  async function redirectWithSession(session) {
    const url = new URL(STREAMLIT_APP_URL);
    url.searchParams.set("access_token", session.access_token);
    url.searchParams.set("refresh_token", session.refresh_token);
    window.location.replace(url.toString());
  }

  async function startLogin() {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: { redirectTo: THIS_PAGE_URL },
    });
    if (error) {
      const url = new URL(STREAMLIT_APP_URL);
      url.searchParams.set("error", error.message || String(error));
      window.location.replace(url.toString());
    }
  }

  async function main() {
    // 1) read current session (after callback, detectSessionInUrl populates it)
    const { data } = await supabase.auth.getSession();
    let session = data?.session;

    // 2) IMPORTANT: force-refresh so Streamlit receives a valid, current session_id
    if (session?.refresh_token) {
      const { data: rdata, error: rerr } = await supabase.auth.refreshSession({
        refresh_token: session.refresh_token,
      });
      if (!rerr && rdata?.session) session = rdata.session;
    }

    // 3) if we have a session, send fresh tokens to Streamlit
    if (session?.access_token && session?.refresh_token) {
      await redirectWithSession(session);
      return;
    }

    // 4) otherwise begin login
    await startLogin();
  }

  main();
    </script>
  </body>
</html>

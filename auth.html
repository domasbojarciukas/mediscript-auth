<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mediscript Auth Bridge</title>
</head>
<body>
  <script>
    (function () {
      // âœ… IMPORTANT: set these to YOUR real values
      const SUPABASE_URL = "https://REPLACE_WITH_YOUR_PROJECT_REF.supabase.co";
      const APP_URL = "https://REPLACE_WITH_YOUR_STREAMLIT_APP"; // e.g. https://mediscript.streamlit.app

      // --- If tokens are returned in hash (#access_token=...) forward them to Streamlit as query params
      const hash = window.location.hash || "";
      const paramsHash = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : "");

      const access_token = paramsHash.get("access_token");
      const refresh_token = paramsHash.get("refresh_token");
      const error = paramsHash.get("error");
      const error_description = paramsHash.get("error_description");

      if (error || error_description) {
        const url = new URL(APP_URL);
        if (error) url.searchParams.set("error", error);
        if (error_description) url.searchParams.set("error_description", error_description);
        window.location.replace(url.toString());
        return;
      }

      if (access_token && refresh_token) {
        const url = new URL(APP_URL);
        url.searchParams.set("access_token", access_token);
        url.searchParams.set("refresh_token", refresh_token);
        window.location.replace(url.toString());
        return;
      }

      // --- Otherwise, start OAuth from here (this page acts as both entry + return)
      // Build authorize URL and send user to Supabase OAuth
      const authorize = new URL(SUPABASE_URL.replace(/\/$/, "") + "/auth/v1/authorize");
      authorize.searchParams.set("provider", "google");

      // redirect_to must point back to THIS PAGE
      authorize.searchParams.set("redirect_to", window.location.href.split("#")[0]);

      // implicit flow so we get tokens in hash
      authorize.searchParams.set("response_type", "token");

      window.location.replace(authorize.toString());
    })();
  </script>
</body>
</html>

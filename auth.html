<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mediscript Auth Bridge</title>
</head>
<body>
  <script>
    (function () {
      const urlNow = new URL(window.location.href);

      // Recommended: pass these in as query params to the bridge URL
      const APP_URL = (urlNow.searchParams.get("app") || "https://YOUR_STREAMLIT_APP").trim();
      const SUPABASE_URL = (urlNow.searchParams.get("supabase") || "https://YOUR_PROJECT_REF.supabase.co")
        .trim()
        .replace(/\/$/, "");

      const next = urlNow.searchParams.get("next") || "";
      const state_in = urlNow.searchParams.get("state") || "";

      const hash = window.location.hash || "";
      const hashParams = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : "");

      const access_token = hashParams.get("access_token");
      const refresh_token = hashParams.get("refresh_token");
      const expires_in = hashParams.get("expires_in");
      const token_type = hashParams.get("token_type");

      const state_back = hashParams.get("state") || state_in;

      const error = hashParams.get("error") || urlNow.searchParams.get("error");
      const error_description =
        hashParams.get("error_description") || urlNow.searchParams.get("error_description");

      if (error || error_description) {
        const out = new URL(APP_URL);
        if (next) out.searchParams.set("next", next);
        if (state_back) out.searchParams.set("state", state_back);
        if (error) out.searchParams.set("error", error);
        if (error_description) out.searchParams.set("error_description", error_description);
        window.location.replace(out.toString());
        return;
      }

      if (access_token && refresh_token) {
        const out = new URL(APP_URL);
        if (next) out.searchParams.set("next", next);
        if (state_back) out.searchParams.set("state", state_back);

        out.searchParams.set("access_token", access_token);
        out.searchParams.set("refresh_token", refresh_token);
        if (expires_in) out.searchParams.set("expires_in", expires_in);
        if (token_type) out.searchParams.set("token_type", token_type);

        window.location.replace(out.toString());
        return;
      }

      // Guard to avoid loops
      const guardKey = "ms_oauth_attempted";
      if (sessionStorage.getItem(guardKey) === "1") {
        const out = new URL(APP_URL);
        if (next) out.searchParams.set("next", next);
        if (state_in) out.searchParams.set("state", state_in);
        out.searchParams.set("error", "oauth_failed");
        out.searchParams.set("error_description", "OAuth did not return tokens. Check redirect URLs and provider config.");
        window.location.replace(out.toString());
        return;
      }
      sessionStorage.setItem(guardKey, "1");

      // Start OAuth (implicit flow)
      const authorize = new URL(SUPABASE_URL + "/auth/v1/authorize");
      authorize.searchParams.set("provider", "google");
      authorize.searchParams.set("redirect_to", window.location.href.split("#")[0]);
      authorize.searchParams.set("response_type", "token");
      if (state_in) authorize.searchParams.set("state", state_in);

      // ‚ùå Do NOT request offline access in implicit flow
      // authorize.searchParams.set("access_type", "offline");
      // authorize.searchParams.set("prompt", "consent");

      window.location.replace(authorize.toString());
    })();
  </script>
</body>
</html>
